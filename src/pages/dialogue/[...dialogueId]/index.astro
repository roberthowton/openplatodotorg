---
import PageLayout from "@layouts/page-layout.astro";
import "@styles/fonts.css";
import ShowDropdown from "@components/show-dropdown.astro";
import { getLineNumbersFromTeiDom } from "@utils";
import Tei from "@components/Tei.astro";
import PageSelect from "@components/page-select.astro";
import processTei from "@utils/processTei";
import { ShowState } from "@types";

const { dialogueId } = Astro.params;
const showParams = Astro.url.searchParams.getAll("show") as ShowState[];

// If no params, default to both languages
const defaultParams = showParams.length === 0
  ? [ShowState.GREEK, ShowState.ENGLISH]
  : showParams;

const teiFileGr = (
  await import(`../../../content/dialogue/${dialogueId}/gr.xml?raw`)
).default;

const teiDataGr = processTei(teiFileGr);

const teiFileEn = (
  await import(`../../../content/dialogue/${dialogueId}/en.xml?raw`)
).default;
const teiDataEn = processTei(teiFileEn);
const lineNumbersGr = getLineNumbersFromTeiDom(teiDataGr.dom);
const lineNumbersEn = getLineNumbersFromTeiDom(teiDataEn.dom);
const lineNumbers = Array.from(new Set([...lineNumbersGr, ...lineNumbersEn]));

// If firstRead is present, only show first read (it takes precedence)
const showFirstRead = defaultParams.includes(ShowState.FIRST_READ);
const showGreek = !showFirstRead && defaultParams.includes(ShowState.GREEK);
const showEnglish = !showFirstRead && defaultParams.includes(ShowState.ENGLISH);
---

<PageLayout>
  <h1>Dialog Test</h1>
  <ShowDropdown />
  <PageSelect pages={lineNumbers} />
  <main>
    <section class="dialogueContainer">
      {
        showGreek && (
          <div style="width: max-content; margin: 0 2rem">
            <Tei teiData={teiDataGr} language="gr" />
          </div>
        )
      }
      {
        showEnglish && (
          <div style="width: max-content; margin: 0 2rem">
            <Tei teiData={teiDataEn} language="en" />
          </div>
        )
      }
      {
        showFirstRead && (
          <div style="width: max-content; margin: 0 2rem">
            <p>First read content goes here</p>
          </div>
        )
      }
    </section>
  </main>
</PageLayout>

<style>
  .dialogueContainer {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
  }
</style>
