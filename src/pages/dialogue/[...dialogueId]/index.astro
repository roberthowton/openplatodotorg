---
import PageLayout from "@layouts/page-layout.astro";
import "@styles/fonts.css";
import "@styles/annotations.css";
import ShowDropdown from "@components/show-dropdown.astro";
import { getLineNumbersFromTeiDom } from "@utils";
import Tei from "@components/Tei.astro";
import PageSelect from "@components/page-select.astro";
import CommentsPanel from "@components/CommentsPanel.astro";
import processTei from "@utils/processTei";
import { ShowState } from "@types";
import { loadComments } from "@utils/loadComments";
import { parseUrlState } from "../../../state/url";

const { dialogueId } = Astro.params;
if (!dialogueId) throw new Error("dialogueId is required");

const urlState = parseUrlState(Astro.url);
// If no explicit show params, default to both languages (server-side default)
const hasExplicitShowParams = Astro.url.searchParams.getAll("show").length > 0;
const showStates = hasExplicitShowParams ? urlState.show : [ShowState.GREEK, ShowState.ENGLISH];

const teiFileGr = (
  await import(`../../../content/dialogue/${dialogueId}/gr.xml?raw`)
).default;

const teiDataGr = processTei(teiFileGr);

const teiFileEn = (
  await import(`../../../content/dialogue/${dialogueId}/en.xml?raw`)
).default;
const teiDataEn = processTei(teiFileEn);
const lineNumbersGr = getLineNumbersFromTeiDom(teiDataGr.dom);
const lineNumbersEn = getLineNumbersFromTeiDom(teiDataEn.dom);
const lineNumbers = Array.from(new Set([...lineNumbersGr, ...lineNumbersEn]));

// If firstRead is present, only show first read (it takes precedence)
const showFirstRead = showStates.includes(ShowState.FIRST_READ);
const showGreek = !showFirstRead && showStates.includes(ShowState.GREEK);
const showEnglish = !showFirstRead && showStates.includes(ShowState.ENGLISH);

// Load comments for displayed languages
const commentsEn =
  showEnglish || showFirstRead
    ? await loadComments(dialogueId, "en", showFirstRead)
    : null;
const commentsGr = showGreek
  ? await loadComments(dialogueId, "gr", false)
  : null;
---

<PageLayout>
  <h1>Dialog Test</h1>
  <ShowDropdown />
  <PageSelect pages={lineNumbers} />
  <main>
    <section class="dialogueContainer">
      {
        showGreek && (
          <div class="text-column text-column-gr">
            <Tei teiData={teiDataGr} language="gr" />
          </div>
        )
      }
      {
        showEnglish && (
          <div class="text-column text-column-en">
            <Tei
              teiData={teiDataEn}
              language="en"
              hideLineNumbers={showGreek}
            />
          </div>
        )
      }
      {
        showFirstRead && (
          <div class="text-column">
            <p>First read content goes here</p>
          </div>
        )
      }
    </section>
  </main>
  <CommentsPanel />
  {
    commentsEn && (
      <script
        type="application/json"
        id="comments-en"
        set:html={JSON.stringify(commentsEn)}
      />
    )
  }
  {
    commentsGr && (
      <script
        type="application/json"
        id="comments-gr"
        set:html={JSON.stringify(commentsGr)}
      />
    )
  }
  <script>
    // Detect text wrapping and switch to inline mode dynamically
    function checkOverflow() {
      document.querySelectorAll(".text-column").forEach((column) => {
        const lines = column.querySelectorAll(".stephanus-line");
        let hasWrapping = false;

        // Get computed line-height to detect wrapping
        lines.forEach((line) => {
          const style = window.getComputedStyle(line);
          const lineHeight =
            parseFloat(style.lineHeight) || parseFloat(style.fontSize) * 1.5;
          // If element height is significantly more than one line, text has wrapped
          if (
            line instanceof HTMLElement &&
            line.offsetHeight > lineHeight * 1.3
          ) {
            hasWrapping = true;
          }
        });

        if (hasWrapping) {
          column.classList.add("inline-mode");
        } else {
          column.classList.remove("inline-mode");
        }
      });
    }

    // Run on load and resize
    window.addEventListener("load", checkOverflow);
    window.addEventListener("resize", checkOverflow);

    // Also observe DOM changes (for when TEI content renders)
    const observer = new MutationObserver(checkOverflow);
    observer.observe(document.body, { childList: true, subtree: true });
  </script>
</PageLayout>

<style is:global>
  .dialogueContainer {
    display: grid;
    grid-template-columns: fit-content(45%) fit-content(55%);
    gap: 2rem;
    align-items: start;
    padding-right: 60px;
    padding-left: 1rem;
    transition: padding-right 0.3s ease;
  }

  body.comments-panel-pinned .dialogueContainer {
    padding-right: 340px;
  }

  /* When only one column, center it */
  .dialogueContainer:has(> :only-child) {
    grid-template-columns: 1fr;
    justify-items: center;
  }

  .text-column {
    min-width: 0;
    overflow: hidden;
    position: relative;
    contain: paint;
  }

  .dialogueContainer:has(> :only-child) .text-column {
    max-width: 70ch;
  }

  .text-column tei-container,
  .text-column tei-tei,
  .text-column tei-text,
  .text-column tei-body {
    width: 100% !important;
    max-width: 100% !important;
  }

  .text-column tei-lb {
    max-width: 100% !important;
    width: 100% !important;
    box-sizing: border-box !important;
  }

  .text-column tei-l {
    width: 100% !important;
    max-width: 100% !important;
  }

  @media (max-width: 768px) {
    .dialogueContainer {
      flex-direction: column;
      padding-right: 0;
      padding-left: 0;
      padding-bottom: 60px;
      transition: padding-bottom 0.3s ease;
    }

    body.comments-panel-pinned .dialogueContainer {
      padding-right: 0;
      padding-bottom: 45vh;
    }

    .text-column {
      max-width: none;
      padding: 0 1rem;
    }
  }
</style>
