---
import PageLayout from "@layouts/page-layout.astro";
import "@styles/fonts.css";
import "@styles/annotations.css";
import ShowDropdown from "@components/show-dropdown.astro";
import { getLineNumbersFromTeiDom } from "@utils";
import Tei from "@components/Tei.astro";
import PageSelect from "@components/page-select.astro";
import CommentsPanel from "@components/CommentsPanel.astro";
import processTei from "@utils/processTei";
import { ShowState } from "@types";
import { loadComments } from "@utils/loadComments";

const { dialogueId } = Astro.params;
if (!dialogueId) throw new Error("dialogueId is required");
const showParams = Astro.url.searchParams.getAll("show") as ShowState[];

// If no params, default to both languages
const defaultParams = showParams.length === 0
  ? [ShowState.GREEK, ShowState.ENGLISH]
  : showParams;

const teiFileGr = (
  await import(`../../../content/dialogue/${dialogueId}/gr.xml?raw`)
).default;

const teiDataGr = processTei(teiFileGr);

const teiFileEn = (
  await import(`../../../content/dialogue/${dialogueId}/en.xml?raw`)
).default;
const teiDataEn = processTei(teiFileEn);
const lineNumbersGr = getLineNumbersFromTeiDom(teiDataGr.dom);
const lineNumbersEn = getLineNumbersFromTeiDom(teiDataEn.dom);
const lineNumbers = Array.from(new Set([...lineNumbersGr, ...lineNumbersEn]));

// If firstRead is present, only show first read (it takes precedence)
const showFirstRead = defaultParams.includes(ShowState.FIRST_READ);
const showGreek = !showFirstRead && defaultParams.includes(ShowState.GREEK);
const showEnglish = !showFirstRead && defaultParams.includes(ShowState.ENGLISH);

// Load comments for displayed languages
const commentsEn = showEnglish || showFirstRead
  ? await loadComments(dialogueId, "en", showFirstRead)
  : null;
const commentsGr = showGreek
  ? await loadComments(dialogueId, "gr", false)
  : null;
---

<PageLayout>
  <h1>Dialog Test</h1>
  <ShowDropdown />
  <PageSelect pages={lineNumbers} />
  <main>
    <section class="dialogueContainer">
      {
        showGreek && (
          <div style="width: max-content; margin: 0 2rem">
            <Tei teiData={teiDataGr} language="gr" />
          </div>
        )
      }
      {
        showEnglish && (
          <div style="width: max-content; margin: 0 2rem">
            <Tei teiData={teiDataEn} language="en" hideLineNumbers={showGreek} />
          </div>
        )
      }
      {
        showFirstRead && (
          <div style="width: max-content; margin: 0 2rem">
            <p>First read content goes here</p>
          </div>
        )
      }
    </section>
  </main>
  <CommentsPanel />
  {commentsEn && (
    <script type="application/json" id="comments-en" set:html={JSON.stringify(commentsEn)} />
  )}
  {commentsGr && (
    <script type="application/json" id="comments-gr" set:html={JSON.stringify(commentsGr)} />
  )}
</PageLayout>

<style>
  .dialogueContainer {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    /* Account for comments panel width */
    padding-right: 340px;
  }

  @media (max-width: 768px) {
    .dialogueContainer {
      padding-right: 0;
      /* Account for bottom panel on mobile */
      padding-bottom: 45vh;
    }
  }
</style>
