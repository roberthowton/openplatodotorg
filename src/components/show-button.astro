---
import { ShowState } from "../types";

type Props = {
  show: ShowState;
};

const { show: buttonShowState } = Astro.props;
const urlShowParams = Astro.url.searchParams.getAll("show") as ShowState[];

// Determine if this button's state is currently active
let isShowing = false;
if (buttonShowState === ShowState.FIRST_READ) {
  isShowing = urlShowParams.includes(ShowState.FIRST_READ);
} else if (
  buttonShowState === ShowState.GREEK ||
  buttonShowState === ShowState.ENGLISH
) {
  isShowing =
    urlShowParams.includes(buttonShowState) || urlShowParams.length === 0;
}
---

<show-button data-show={buttonShowState}>
  <div class="control">
    <label class=`show-${buttonShowState}`>
      <input
        type="radio"
        name=`toggle-${buttonShowState}`
        checked={isShowing}
      />
      <slot name="show_text" />
    </label>
    <label class=`hide-${buttonShowState}`>
      <input
        type="radio"
        name=`toggle-${buttonShowState}`
        checked={!isShowing}
      />
      <slot name="hide_text" />
    </label>
  </div>
</show-button>

<script>
  import { dispatch, getUrlState } from "../state/url";
  import { ShowState } from "../types";

  class ShowButton extends HTMLElement {
    connectedCallback() {
      const show = this.dataset.show as ShowState;
      const showRadio = this.querySelector(
        `label[class="show-${show}"]`,
      )?.querySelector("input");
      const hideRadio = this.querySelector(
        `label[class="hide-${show}"]`,
      )?.querySelector("input");

      showRadio?.addEventListener("change", () => {
        if (show === ShowState.FIRST_READ) {
          dispatch({ type: "SET_FIRST_READ" });
        } else {
          // Add this language to current show state
          const state = getUrlState();
          if (!state.show.includes(show)) {
            dispatch({ type: "SET_SHOW", payload: [...state.show.filter(s => s !== ShowState.FIRST_READ), show] });
          }
        }
      });

      hideRadio?.addEventListener("change", () => {
        if (show === ShowState.FIRST_READ) {
          dispatch({ type: "EXIT_FIRST_READ" });
        } else {
          // Remove this language from current show state
          const state = getUrlState();
          const newShow = state.show.filter((s) => s !== show && s !== ShowState.FIRST_READ);
          if (newShow.length === 0) {
            // If nothing left, go to opposite language
            const opposite = show === ShowState.GREEK ? ShowState.ENGLISH : ShowState.GREEK;
            dispatch({ type: "SET_SHOW", payload: [opposite] });
          } else {
            dispatch({ type: "SET_SHOW", payload: newShow });
          }
        }
      });
    }
  }

  customElements.define("show-button", ShowButton);
</script>

<style>
  .control label:has(:checked) {
    display: none;
  }
</style>
