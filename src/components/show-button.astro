---
import { ShowState } from "../types";

type Props = {
  show: ShowState;
};

const { show: buttonShowState } = Astro.props;
const urlShowParams = Astro.url.searchParams.getAll("show") as ShowState[];

// Determine if this button's state is currently active
let isShowing = false;
if (buttonShowState === ShowState.FIRST_READ) {
  isShowing = urlShowParams.includes(ShowState.FIRST_READ);
} else if (
  buttonShowState === ShowState.GREEK ||
  buttonShowState === ShowState.ENGLISH
) {
  isShowing =
    urlShowParams.includes(buttonShowState) || urlShowParams.length === 0;
}
---

<show-button data-show={buttonShowState}>
  <div class="control">
    <label class=`show-${buttonShowState}`>
      <input
        type="radio"
        name=`toggle-${buttonShowState}`
        checked={isShowing}
      />
      <slot name="show_text" />
    </label>
    <label class=`hide-${buttonShowState}`>
      <input
        type="radio"
        name=`toggle-${buttonShowState}`
        checked={!isShowing}
      />
      <slot name="hide_text" />
    </label>
  </div>
</show-button>

<script>
  import { navigate } from "astro:transitions/client";
  import { ShowState } from "../types";

  class ShowButton extends HTMLElement {
    connectedCallback() {
      const show = this.dataset.show;
      const showRadio = this.querySelector(
        `label[class="show-${show}"]`,
      )?.querySelector("input");
      const hideRadio = this.querySelector(
        `label[class="hide-${show}"]`,
      )?.querySelector("input");

      showRadio?.addEventListener("change", () => {
        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);

        if (show === ShowState.FIRST_READ) {
          // Entering first read mode - clear all and set firstRead
          params.delete("show");
          params.set("show", ShowState.FIRST_READ);
        } else {
          // Add this show state if not already present
          const currentShowParams = params.getAll("show");
          if (!currentShowParams.includes(show as string)) {
            params.append("show", show as string);
          }
        }

        url.search = params.toString();
        navigate(url.href);
      });

      hideRadio?.addEventListener("change", () => {
        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);

        if (show === ShowState.FIRST_READ) {
          // Exiting first read mode - show both languages
          params.delete("show");
          params.append("show", ShowState.GREEK);
          params.append("show", ShowState.ENGLISH);
        } else {
          const currentShowParams = params.getAll("show");
          params.delete("show");

          if (currentShowParams.length === 0) {
            // No params means both shown; add the opposite language
            const opposite =
              show === ShowState.GREEK
                ? ShowState.ENGLISH
                : ShowState.GREEK;
            params.append("show", opposite);
          } else {
            // Remove this specific show state
            currentShowParams.forEach((param) => {
              if (param !== show) {
                params.append("show", param);
              }
            });
          }
        }

        url.search = params.toString();
        navigate(url.href);
      });
    }
  }

  customElements.define("show-button", ShowButton);
</script>

<style>
  .control label:has(:checked) {
    display: none;
  }
</style>
