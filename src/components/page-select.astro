---
type Props = {
  pages: (string | null)[];
};

const ref = Astro.url.searchParams.get("ref");
const initialValue = ref ?? "";

const { pages } = Astro.props;
---

<div class="dropdown" data-lines={JSON.stringify(pages)}>
  <input
    type="text"
    id="searchInput"
    placeholder="Search references or text..."
    autocomplete="off"
    value={initialValue}
  />
  <ul id="dropdownList" class="dropdown-list"></ul>
</div>

<script>
  import { addOrUpdateUrlParam } from "../utils";
  import {
    type SearchResult,
    extractReferenceFromId,
    createPreview,
    highlightMatch
  } from "./page-select-client";

  const dropdown = document.querySelector(".dropdown") as HTMLElement;
  const searchInput = document.getElementById("searchInput") as HTMLInputElement;
  const dropdownList = document.getElementById("dropdownList") as HTMLElement;

  const items: (string | null)[] = JSON.parse(dropdown.dataset?.lines || "[]");

  // Helper function to detect which text languages are currently visible
  function getVisibleLanguages(): string[] {
    const containers = document.querySelectorAll('tei-container');
    const languages: string[] = [];

    containers.forEach((container) => {
      const element = container as HTMLElement;
      if (element.offsetParent !== null) {
        const language = element.dataset.language;
        if (language) languages.push(language);
      }
    });

    return languages;
  }

  // Search text content in visible languages
  function searchTextContent(searchText: string): SearchResult[] {
    const textResults: SearchResult[] = [];
    const searchLower = searchText.toLowerCase();
    const MAX_TEXT_RESULTS = 50;

    const visibleLanguages = getVisibleLanguages();

    visibleLanguages.forEach(language => {
      if (textResults.length >= MAX_TEXT_RESULTS) return;

      const textDivs = document.querySelectorAll(`div[id$="-${language}-text"]`);

      textDivs.forEach((div) => {
        if (textResults.length >= MAX_TEXT_RESULTS) return;

        const textContent = div.textContent || '';
        const lowerText = textContent.toLowerCase();

        if (lowerText.includes(searchLower)) {
          const matchIndex = lowerText.indexOf(searchLower);
          const reference = extractReferenceFromId(div.id, language);
          const preview = createPreview(textContent, matchIndex, searchText.length);

          textResults.push({
            type: 'text',
            reference,
            textPreview: preview,
            matchIndex
          });
        }
      });
    });

    return textResults;
  }

  // Perform dual search: references and text content
  function performSearch(searchText: string): {
    referenceResults: SearchResult[];
    textResults: SearchResult[];
  } {
    const referenceResults: SearchResult[] = [];
    const textResults: SearchResult[] = [];

    if (!searchText) {
      return { referenceResults, textResults };
    }

    const searchLower = searchText.toLowerCase();

    // 1. Search references
    const matchingRefs = items.filter((item) =>
      item?.toLowerCase().includes(searchLower)
    );

    referenceResults.push(...matchingRefs.map(ref => ({
      type: 'reference' as const,
      reference: ref || ''
    })));

    // 2. Search text content
    textResults.push(...searchTextContent(searchText));

    return { referenceResults, textResults };
  }

  // Render organized dropdown with References and Search Results sections
  function renderDropdown(
    referenceResults: SearchResult[],
    textResults: SearchResult[]
  ): void {
    dropdownList.innerHTML = '';

    const hasResults = referenceResults.length > 0 || textResults.length > 0;

    if (!hasResults) {
      dropdownList.style.display = 'none';
      return;
    }

    dropdownList.style.display = 'block';

    // Render References Section
    if (referenceResults.length > 0) {
      const refHeader = document.createElement('li');
      refHeader.className = 'section-header';
      refHeader.textContent = 'References';
      dropdownList.appendChild(refHeader);

      referenceResults.forEach(result => {
        const li = document.createElement('li');
        li.className = 'reference-item';
        li.textContent = result.reference;
        li.dataset.ref = result.reference;
        li.onclick = () => selectReference(result.reference);
        dropdownList.appendChild(li);
      });
    }

    // Render Text Results Section
    if (textResults.length > 0) {
      const textHeader = document.createElement('li');
      textHeader.className = 'section-header';
      textHeader.textContent = 'Search Results';
      dropdownList.appendChild(textHeader);

      textResults.forEach(result => {
        const li = document.createElement('li');
        li.className = 'text-item';
        li.dataset.ref = result.reference;

        const refDiv = document.createElement('div');
        refDiv.className = 'result-ref';
        refDiv.textContent = result.reference;

        const previewDiv = document.createElement('div');
        previewDiv.className = 'result-preview';
        previewDiv.innerHTML = highlightMatch(
          result.textPreview || '',
          searchInput.value
        );

        li.appendChild(refDiv);
        li.appendChild(previewDiv);
        li.onclick = () => selectReference(result.reference);

        dropdownList.appendChild(li);
      });
    }
  }

  function selectReference(value: string | null) {
    searchInput.value = value || "";
    dropdownList.style.display = "none";

    if (!value) return;

    // Find all matching text divs (Greek, English, or both)
    const selectedLines = document.querySelectorAll(
      `div[id='${value}-gr-text'], div[id='${value}-en-text']`
    );

    if (selectedLines.length > 0) {
      // Scroll to the first visible reference
      selectedLines[0].scrollIntoView({ behavior: "smooth" });

      // Highlight all visible references
      selectedLines.forEach((line) => {
        line.classList.add("highlight");
      });

      addOrUpdateUrlParam("ref", value);

      // Remove highlight from all after 2 seconds
      setTimeout(() => {
        selectedLines.forEach((line) => {
          line.classList.remove("highlight");
        });
      }, 2000);
    }
  }

  document.onreadystatechange = () => {
    if (document.readyState === "complete" && searchInput.value) {
      selectReference(searchInput.value);
    }
  };

  // Listen for input changes with debouncing
  let searchTimeout: number;

  searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);

    const searchText = searchInput.value;

    if (!searchText) {
      dropdownList.style.display = 'none';
      return;
    }

    // Debounce for 150ms to avoid searching on every keystroke
    searchTimeout = window.setTimeout(() => {
      const { referenceResults, textResults } = performSearch(searchText);
      renderDropdown(referenceResults, textResults);
    }, 150);
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!dropdown.contains(e.target as Node)) {
      dropdownList.style.display = 'none';
    }
  });

  // Prevent dropdown from closing when clicking inside
  dropdown.addEventListener('click', (e) => {
    e.stopPropagation();
  });
</script>

<style is:global>
  .highlight {
    background-color: yellow;
  }
</style>

<style>
  .dropdown {
    position: relative;
    width: 300px;
  }

  #searchInput {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 5px;
  }

  .dropdown-list {
    position: absolute;
    width: 100%;
    max-height: 400px;
    overflow-y: auto;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 5px;
    display: none;
    list-style: none;
    padding: 0;
    z-index: 1000;
  }

  /* Section headers */
  .section-header {
    padding: 8px 12px;
    font-weight: bold;
    font-size: 0.85em;
    color: #666;
    background: #f5f5f5;
    border-bottom: 1px solid #e0e0e0;
    cursor: default;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    user-select: none;
  }

  .section-header:not(:first-child) {
    margin-top: 4px;
    border-top: 1px solid #e0e0e0;
  }

  /* Reference items */
  .reference-item {
    padding: 8px 12px;
    cursor: pointer;
    font-family: monospace;
  }

  .reference-item:hover {
    background: #f0f0f0;
  }

  /* Text search result items */
  .text-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
  }

  .text-item:last-child {
    border-bottom: none;
  }

  .text-item:hover {
    background: #f9f9f9;
  }

  .result-ref {
    font-family: monospace;
    font-weight: bold;
    color: #333;
    margin-bottom: 4px;
    font-size: 0.9em;
  }

  .result-preview {
    color: #666;
    font-size: 0.85em;
    line-height: 1.4;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Highlight matched text in preview */
  .result-preview mark {
    background-color: #ffeb3b;
    color: #000;
    font-weight: 600;
    padding: 0 2px;
    border-radius: 2px;
  }
</style>
